#script-base

#!/bin/bash

# #!/bin/bash
set -e  # Encerra o script se qualquer comando falhar

echo -e "\nğŸ”” BLOCO 1: Iniciando criaÃ§Ã£o da estrutura de diretÃ³rios..."

# DiretÃ³rios base
SITES_DIR="/home/site4have/sites"
CADDY_DIR="/home/site4have/Caddy"
CADDY_SITES_DIR="$CADDY_DIR/sites"
CADDYFILE="$CADDY_DIR/Caddyfile"

# Verifica permissÃ£o para criar diretÃ³rio base
BASE_DIR="/home/site4have"
if [ ! -d "$BASE_DIR" ]; then
  echo "âŒ DiretÃ³rio base nÃ£o existe: $BASE_DIR"
  exit 1
elif [ ! -w "$BASE_DIR" ]; then
  echo "âŒ Sem permissÃ£o para escrever em: $BASE_DIR"
  exit 1
fi

# CriaÃ§Ã£o da pasta dos sites
if [ ! -d "$SITES_DIR" ]; then
  mkdir -p "$SITES_DIR"
  echo "âœ… DiretÃ³rio criado: $SITES_DIR"
else
  echo "ğŸ”„ DiretÃ³rio jÃ¡ existe: $SITES_DIR"
fi

# CriaÃ§Ã£o da pasta principal do Caddy
if [ ! -d "$CADDY_DIR" ]; then
  mkdir -p "$CADDY_DIR"
  echo "âœ… DiretÃ³rio criado: $CADDY_DIR"
else
  echo "ğŸ”„ DiretÃ³rio jÃ¡ existe: $CADDY_DIR"
fi

# CriaÃ§Ã£o da subpasta de sites do Caddy
if [ ! -d "$CADDY_SITES_DIR" ]; then
  mkdir -p "$CADDY_SITES_DIR"
  echo "âœ… DiretÃ³rio criado: $CADDY_SITES_DIR"
else
  echo "ğŸ”„ DiretÃ³rio jÃ¡ existe: $CADDY_SITES_DIR"
fi

# Verifica permissÃ£o para criar o Caddyfile
if [ ! -w "$CADDY_DIR" ]; then
  echo "âŒ Sem permissÃ£o para criar arquivo em: $CADDY_DIR"
  exit 1
fi

# CriaÃ§Ã£o do Caddyfile principal com import, se nÃ£o existir
if [ ! -f "$CADDYFILE" ]; then
  echo "import $CADDY_SITES_DIR/*.conf" > "$CADDYFILE"
  echo "âœ… Arquivo criado: $CADDYFILE (com linha de importaÃ§Ã£o)"
else
  echo "ğŸ”„ Arquivo jÃ¡ existe: $CADDYFILE"
fi

echo -e "âœ… BLOCO 1 finalizado com sucesso!\n"
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸŒ BLOCO 2 â€” CRIAÃ‡ÃƒO DA REDE PODMAN COMPARTILHADA (AMPLIADA)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\nğŸ”” BLOCO 2: Iniciando criaÃ§Ã£o da rede Podman compartilhada..."

NETWORK_NAME="shared_network"
SUBNET="192.168.0.0/16"
GATEWAY="192.168.0.1"

# Verifica se a rede jÃ¡ existe
if podman network exists "$NETWORK_NAME"; then
  echo "ğŸ”„ A rede '$NETWORK_NAME' jÃ¡ existe."
else
  podman network create \
    --subnet "$SUBNET" \
    --gateway "$GATEWAY" \
    "$NETWORK_NAME"

  if [ $? -eq 0 ]; then
    echo "âœ… Rede '$NETWORK_NAME' criada com sucesso!"
    echo "ğŸ›£ï¸ Subrede: $SUBNET | Gateway: $GATEWAY"
  else
    echo "âŒ Falha ao criar a rede '$NETWORK_NAME'."
    exit 1
  fi
fi

echo -e "âœ… BLOCO 2 finalizado com sucesso!\n"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ³ BLOCO 3 â€” CRIAÃ‡ÃƒO DOS CONTAINERS BASE (MariaDB + Caddy)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\nğŸ”” BLOCO 3: Iniciando criaÃ§Ã£o dos containers base..."

# DiretÃ³rios criados no Bloco 1
USER_HOME=$(eval echo ~"$USER")
CADDY_DIR="$USER_HOME/Caddy"
CADDY_SITES_DIR="$CADDY_DIR/sites"
CADDYFILE="$CADDY_DIR/Caddyfile"

# Gerar senha aleatÃ³ria segura para o MariaDB root
MARIADB_ROOT_PASS=$(openssl rand -base64 24)
echo "ğŸ” Senha root do MariaDB gerada automaticamente."

# Container MariaDB
MARIADB_NAME="mariadb-container"
MARIADB_VOLUME="mariadb_data"

if podman container exists "$MARIADB_NAME"; then
  echo "ğŸ”„ Container MariaDB '$MARIADB_NAME' jÃ¡ existe."
else
  podman volume create "$MARIADB_VOLUME" >/dev/null

  podman run -d \
    --name "$MARIADB_NAME" \
    --network shared_network \
    -e MYSQL_ROOT_PASSWORD="$MARIADB_ROOT_PASS" \
    -v "$MARIADB_VOLUME":/var/lib/mysql \
    docker.io/library/mariadb:10.6

  if [ $? -eq 0 ]; then
    echo "âœ… Container '$MARIADB_NAME' criado com sucesso!"
    echo -e "\nğŸ”‘ \e[1mSenha gerada para o usuÃ¡rio root do MariaDB:\e[0m\n\e[1;32m$MARIADB_ROOT_PASS\e[0m\n"
  else
    echo "âŒ Erro ao criar o container '$MARIADB_NAME'."
    exit 1
  fi
fi

# Container Caddy
CADDY_NAME="caddy"
CADDY_VOLUME_DATA="caddy_data"
CADDY_VOLUME_CONFIG="caddy_config"

if podman container exists "$CADDY_NAME"; then
  echo "ğŸ”„ Container Caddy '$CADDY_NAME' jÃ¡ existe."
else
  podman volume create "$CADDY_VOLUME_DATA" >/dev/null
  podman volume create "$CADDY_VOLUME_CONFIG" >/dev/null

  podman run -d \
    --name "$CADDY_NAME" \
    --network shared_network \
    -p 80:80 -p 443:443 \
    -v "$CADDYFILE":/etc/caddy/Caddyfile:ro \
    -v "$CADDY_SITES_DIR":/etc/caddy/sites:ro \
    -v "$CADDY_VOLUME_DATA":/data \
    -v "$CADDY_VOLUME_CONFIG":/config \
    docker.io/caddy:latest

  if [ $? -eq 0 ]; then
    echo "âœ… Container '$CADDY_NAME' criado com sucesso!"
  else
    echo "âŒ Erro ao criar o container '$CADDY_NAME'."
    exit 1
  fi
fi

echo -e "âœ… BLOCO 3 finalizado com sucesso!\n"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš™ï¸ BLOCO 4 â€” INSTALAÃ‡ÃƒO DE SERVIÃ‡OS SYSTEMD PARA CONTAINERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\nğŸ”” BLOCO 4: Instalando serviÃ§os systemd para manter containers ativos..."

SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
mkdir -p "$SYSTEMD_USER_DIR"

# Habilita linger para que os serviÃ§os continuem mesmo com o usuÃ¡rio deslogado
echo "ğŸ”§ Habilitando linger para o usuÃ¡rio $USER..."
if loginctl enable-linger "$USER"; then
  echo "âœ… Linger habilitado com sucesso!"
else
  echo "âš ï¸ Falha ao habilitar linger. Verifique permissÃµes (precisa de sudo/root)."
fi

# MariaDB - Service Unit
cat <<EOF > "$SYSTEMD_USER_DIR/podman-mariadb-container.service"
[Unit]
Description=MariaDB container via Podman
After=network.target

[Service]
ExecStart=/usr/bin/podman start -a mariadb-container
ExecStop=/usr/bin/podman stop -t 10 mariadb-container
Restart=always
RestartSec=5

[Install]
WantedBy=default.target
EOF

# Caddy - Service Unit
cat <<EOF > "$SYSTEMD_USER_DIR/podman-caddy.service"
[Unit]
Description=Caddy container via Podman
After=network.target

[Service]
ExecStart=/usr/bin/podman start -a caddy
ExecStop=/usr/bin/podman stop -t 10 caddy
Restart=always
RestartSec=5

[Install]
WantedBy=default.target
EOF

# Recarrega e ativa os serviÃ§os
systemctl --user daemon-reexec
systemctl --user daemon-reload

systemctl --user enable podman-mariadb-container.service
systemctl --user enable podman-caddy.service

systemctl --user start podman-mariadb-container.service
systemctl --user start podman-caddy.service

echo "âœ… ServiÃ§os systemd criados e ativados!"
echo "ğŸ” Containers agora serÃ£o reiniciados automaticamente se pararem ou ao reiniciar o sistema."
echo -e "âœ… BLOCO 4 finalizado com sucesso!\n"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… BLOCO 5 â€” VERIFICAÃ‡ÃƒO FINAL E RESUMO
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo -e "\nğŸ”” BLOCO 5: Verificando integridade do ambiente e serviÃ§os..."

STATUS_OK=true

echo -e "\nğŸ“‚ Verificando diretÃ³rios..."
check_dir() {
  if [ -d "$1" ]; then
    echo "âœ… Existe: $1"
  else
    echo "âŒ NÃ£o encontrado: $1"
    STATUS_OK=false
  fi
}
check_dir "/home/site4have/sites"
check_dir "/home/site4have/Caddy"
check_dir "/home/site4have/Caddy/sites"

echo -e "\nğŸ“„ Verificando arquivos essenciais..."
[ -f "/home/site4have/Caddy/Caddyfile" ] && echo "âœ… Caddyfile encontrado" || { echo "âŒ Caddyfile ausente"; STATUS_OK=false; }

echo -e "\nğŸŒ Verificando rede Podman..."
if podman network exists shared_network; then
  echo "âœ… Rede 'shared_network' estÃ¡ ativa"
else
  echo "âŒ Rede 'shared_network' nÃ£o existe"
  STATUS_OK=false
fi

echo -e "\nğŸ³ Verificando containers..."
check_container() {
  if podman container exists "$1"; then
    if [ "$(podman inspect -f '{{.State.Running}}' "$1")" == "true" ]; then
      echo "âœ… Container '$1' estÃ¡ em execuÃ§Ã£o"
    else
      echo "âŒ Container '$1' existe, mas estÃ¡ parado"
      STATUS_OK=false
    fi
  else
    echo "âŒ Container '$1' nÃ£o existe"
    STATUS_OK=false
  fi
}
check_container "mariadb-container"
check_container "caddy"

echo -e "\nğŸ› ï¸ Verificando serviÃ§os systemd..."
check_service() {
  systemctl --user is-enabled "$1" &>/dev/null && ENABLED="Sim" || ENABLED="NÃ£o"
  systemctl --user is-active "$1" &>/dev/null && ACTIVE="Ativo" || ACTIVE="Inativo"
  echo "ğŸ”§ $1 â€” Ativo: $ACTIVE | Habilitado: $ENABLED"
  [[ $ACTIVE == "Ativo" ]] && [[ $ENABLED == "Sim" ]] || STATUS_OK=false
}
check_service "podman-mariadb-container.service"
check_service "podman-caddy.service"

# RESUMO
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ RESUMO DO AMBIENTE CONFIGURADO:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ DiretÃ³rios:"
echo "  - /home/site4have/sites"
echo "  - /home/site4have/Caddy"
echo "  - /home/site4have/Caddy/sites"
echo
echo "ğŸ“„ Arquivos:"
echo "  - /home/site4have/Caddy/Caddyfile"
echo "  - ~/.config/systemd/user/podman-mariadb-container.service"
echo "  - ~/.config/systemd/user/podman-caddy.service"
echo
echo "ğŸŒ Rede:"
echo "  - Nome: shared_network"
echo "  - Faixa IP: personalizada (ex: 192.168.100.0/24)"
echo
echo "ğŸ³ Containers:"
echo "  - mariadb-container (imagem: mariadb:10.6)"
echo "  - caddy (imagem: caddy:latest)"
echo
echo "ğŸ› ï¸ systemd (modo usuÃ¡rio):"
echo "  - ServiÃ§os criados e ativados para reinÃ­cio automÃ¡tico"
echo
if $STATUS_OK; then
  echo "âœ… AMBIENTE CONFIGURADO COM SUCESSO!"
else
  echo "âš ï¸ ALGUNS ITENS FALHARAM. VERIFIQUE AS MENSAGENS ACIMA."
fi
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
